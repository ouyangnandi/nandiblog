"use strict";goog.provide("Blockly.Language.procedures");goog.require("Blockly.Language");Blockly.Language.procedures_defnoreturn={category:null,helpUrl:Blockly.LANG_PROCEDURES_DEFNORETURN_HELPURL,init:function(){this.setColour(290);var a=Blockly.Procedures.findLegalName(Blockly.LANG_PROCEDURES_DEFNORETURN_PROCEDURE,this);this.appendDummyInput().appendTitle(new Blockly.FieldTextInput(a,Blockly.Procedures.rename),"NAME").appendTitle("","PARAMS");this.appendStatementInput("STACK").appendTitle(Blockly.LANG_PROCEDURES_DEFNORETURN_DO);this.setMutator(new Blockly.Mutator(["procedures_mutatorarg"]));this.setTooltip(Blockly.LANG_PROCEDURES_DEFNORETURN_TOOLTIP);this.arguments_=[]},updateParams_:function(){var b=false;var c={};for(var a=0;a<this.arguments_.length;a++){if(c["arg_"+this.arguments_[a].toLowerCase()]){b=true;break}c["arg_"+this.arguments_[a].toLowerCase()]=true}if(b){this.setWarningText(Blockly.LANG_PROCEDURES_DEF_DUPLICATE_WARNING)}else{this.setWarningText(null)}var d=this.arguments_.join(", ");this.setTitleValue(d,"PARAMS")},mutationToDom:function(){var b=document.createElement("mutation");for(var a=0;a<this.arguments_.length;a++){var c=document.createElement("arg");c.setAttribute("name",this.arguments_[a]);b.appendChild(c)}return b},domToMutation:function(c){this.arguments_=[];for(var a=0,b;b=c.childNodes[a];a++){if(b.nodeName.toLowerCase()=="arg"){this.arguments_.push(b.getAttribute("name"))}}this.updateParams_()},decompose:function(e){var c=new Blockly.Block(e,"procedures_mutatorcontainer");c.initSvg();var d=c.getInput("STACK").connection;for(var b=0;b<this.arguments_.length;b++){var a=new Blockly.Block(e,"procedures_mutatorarg");a.initSvg();a.setTitleValue(this.arguments_[b],"NAME");a.oldLocation=b;d.connect(a.previousConnection);d=a.nextConnection}Blockly.Procedures.mutateCallers(this.getTitleValue("NAME"),this.workspace,this.arguments_,null);return c},compose:function(b){this.arguments_=[];this.paramIds_=[];var a=b.getInputTargetBlock("STACK");while(a){this.arguments_.push(a.getTitleValue("NAME"));this.paramIds_.push(a.id);a=a.nextConnection&&a.nextConnection.targetBlock()}this.updateParams_();Blockly.Procedures.mutateCallers(this.getTitleValue("NAME"),this.workspace,this.arguments_,this.paramIds_)},dispose:function(){var b=this.getTitleValue("NAME");var c=this.editable;var a=this.workspace;Blockly.Block.prototype.dispose.apply(this,arguments);if(c){Blockly.Procedures.disposeCallers(b,a)}},getProcedureDef:function(){return[this.getTitleValue("NAME"),this.arguments_,false]},getVars:function(){return this.arguments_},renameVar:function(c,b){var f=false;for(var a=0;a<this.arguments_.length;a++){if(Blockly.Names.equals(c,this.arguments_[a])){this.arguments_[a]=b;f=true}}if(f){this.updateParams_();if(this.mutator.isVisible_()){var e=this.mutator.workspace_.getAllBlocks();for(var a=0,d;d=e[a];a++){if(d.type=="procedures_mutatorarg"&&Blockly.Names.equals(c,d.getTitleValue("NAME"))){d.setTitleValue(b,"NAME")}}}}},customContextMenu:function(c){var d={enabled:true};var b=this.getTitleValue("NAME");d.text=Blockly.LANG_PROCEDURES_CREATE_DO.replace("%1",b);d.callback=Blockly.ContextMenu.callbackFactory(this,this.callType_,"NAME",b);c.push(d);for(var a=0;a<this.arguments_.length;a++){var d={enabled:true};var b=this.arguments_[a];d.text=Blockly.LANG_VARIABLES_SET_CREATE_GET.replace("%1",b);d.callback=Blockly.ContextMenu.callbackFactory(this,"variables_get","VAR",b);c.push(d)}},callType_:"procedures_callnoreturn"};Blockly.Language.procedures_defreturn={category:null,helpUrl:Blockly.LANG_PROCEDURES_DEFRETURN_HELPURL,init:function(){this.setColour(290);var a=Blockly.Procedures.findLegalName(Blockly.LANG_PROCEDURES_DEFRETURN_PROCEDURE,this);this.appendDummyInput().appendTitle(new Blockly.FieldTextInput(a,Blockly.Procedures.rename),"NAME").appendTitle("","PARAMS");this.appendStatementInput("STACK").appendTitle(Blockly.LANG_PROCEDURES_DEFRETURN_DO);this.appendValueInput("RETURN").setAlign(Blockly.ALIGN_RIGHT).appendTitle(Blockly.LANG_PROCEDURES_DEFRETURN_RETURN);this.setMutator(new Blockly.Mutator(["procedures_mutatorarg"]));this.setTooltip(Blockly.LANG_PROCEDURES_DEFRETURN_TOOLTIP);this.arguments_=[]},updateParams_:Blockly.Language.procedures_defnoreturn.updateParams_,mutationToDom:Blockly.Language.procedures_defnoreturn.mutationToDom,domToMutation:Blockly.Language.procedures_defnoreturn.domToMutation,decompose:Blockly.Language.procedures_defnoreturn.decompose,compose:Blockly.Language.procedures_defnoreturn.compose,dispose:Blockly.Language.procedures_defnoreturn.dispose,getProcedureDef:function(){return[this.getTitleValue("NAME"),this.arguments_,true]},getVars:Blockly.Language.procedures_defnoreturn.getVars,renameVar:Blockly.Language.procedures_defnoreturn.renameVar,customContextMenu:Blockly.Language.procedures_defnoreturn.customContextMenu,callType_:"procedures_callreturn"};Blockly.Language.procedures_mutatorcontainer={init:function(){this.setColour(290);this.appendDummyInput().appendTitle(Blockly.LANG_PROCEDURES_MUTATORCONTAINER_TITLE);this.appendStatementInput("STACK");this.setTooltip("");this.contextMenu=false}};Blockly.Language.procedures_mutatorarg={init:function(){this.setColour(290);this.appendDummyInput().appendTitle(Blockly.LANG_PROCEDURES_MUTATORARG_TITLE).appendTitle(new Blockly.FieldTextInput("x",this.validator),"NAME");this.setPreviousStatement(true);this.setNextStatement(true);this.setTooltip("");this.contextMenu=false}};Blockly.Language.procedures_mutatorarg.validator=function(a){a=a.replace(/[\s\xa0]+/g," ").replace(/^ | $/g,"");return a||null};Blockly.Language.procedures_callnoreturn={category:null,helpUrl:Blockly.LANG_PROCEDURES_CALLNORETURN_HELPURL,init:function(){this.setColour(290);this.appendDummyInput().appendTitle(Blockly.LANG_PROCEDURES_CALLNORETURN_CALL).appendTitle(Blockly.LANG_PROCEDURES_CALLNORETURN_PROCEDURE,"NAME");this.setPreviousStatement(true);this.setNextStatement(true);this.setTooltip(Blockly.LANG_PROCEDURES_CALLNORETURN_TOOLTIP);this.arguments_=[];this.quarkConnections_=null;this.quarkArguments_=null},getProcedureCall:function(){return this.getTitleValue("NAME")},renameProcedure:function(b,a){if(Blockly.Names.equals(b,this.getTitleValue("NAME"))){this.setTitleValue(a,"NAME")}},setProcedureParameters:function(g,e){if(!e){this.quarkConnections_={};this.quarkArguments_=null;return}if(e.length!=g.length){throw"Error: paramNames and paramIds must be the same length."}if(!this.quarkArguments_){this.quarkConnections_={};if(g.join("\n")==this.arguments_.join("\n")){this.quarkArguments_=e}else{this.quarkArguments_=[]}}var f=this.rendered;this.rendered=false;for(var a=this.arguments_.length-1;a>=0;a--){var d=this.getInput("ARG"+a);if(d){var c=d.connection.targetConnection;this.quarkConnections_[this.quarkArguments_[a]]=c;this.removeInput("ARG"+a)}}this.arguments_=[].concat(g);this.quarkArguments_=e;for(var a=0;a<this.arguments_.length;a++){var d=this.appendValueInput("ARG"+a).setAlign(Blockly.ALIGN_RIGHT).appendTitle(this.arguments_[a]);if(this.quarkArguments_){var b=this.quarkArguments_[a];if(b in this.quarkConnections_){var c=this.quarkConnections_[b];if(!c||c.targetConnection||c.sourceBlock_.workspace!=this.workspace){delete this.quarkConnections_[b]}else{d.connection.connect(c)}}}}this.rendered=f;if(this.rendered){this.render()}},mutationToDom:function(){var b=document.createElement("mutation");b.setAttribute("name",this.getTitleValue("NAME"));for(var a=0;a<this.arguments_.length;a++){var c=document.createElement("arg");c.setAttribute("name",this.arguments_[a]);b.appendChild(c)}return b},domToMutation:function(d){var b=d.getAttribute("name");this.setTitleValue(b,"NAME");var e=Blockly.Procedures.getDefinition(b,this.workspace);if(e&&e.mutator.isVisible()){this.setProcedureParameters(e.arguments_,e.paramIds_)}else{this.arguments_=[];for(var a=0,c;c=d.childNodes[a];a++){if(c.nodeName.toLowerCase()=="arg"){this.arguments_.push(c.getAttribute("name"))}}this.setProcedureParameters(this.arguments_,this.arguments_)}},renameVar:function(c,b){for(var a=0;a<this.arguments_.length;a++){if(Blockly.Names.equals(c,this.arguments_[a])){this.arguments_[a]=b;this.getInput("ARG"+a).titleRow[0].setText(b)}}},customContextMenu:function(c){var d={enabled:true};d.text=Blockly.LANG_PROCEDURES_HIGHLIGHT_DEF;var b=this.getTitleValue("NAME");var a=this.workspace;d.callback=function(){var e=Blockly.Procedures.getDefinition(b,a);e&&e.select()};c.push(d)}};Blockly.Language.procedures_callreturn={category:null,helpUrl:Blockly.LANG_PROCEDURES_CALLRETURN_HELPURL,init:function(){this.setColour(290);this.appendDummyInput().appendTitle(Blockly.LANG_PROCEDURES_CALLRETURN_CALL).appendTitle(Blockly.LANG_PROCEDURES_CALLRETURN_PROCEDURE,"NAME");this.setOutput(true,null);this.setTooltip(Blockly.LANG_PROCEDURES_CALLRETURN_TOOLTIP);this.arguments_=[];this.quarkConnections_=null;this.quarkArguments_=null},getProcedureCall:Blockly.Language.procedures_callnoreturn.getProcedureCall,renameProcedure:Blockly.Language.procedures_callnoreturn.renameProcedure,setProcedureParameters:Blockly.Language.procedures_callnoreturn.setProcedureParameters,mutationToDom:Blockly.Language.procedures_callnoreturn.mutationToDom,domToMutation:Blockly.Language.procedures_callnoreturn.domToMutation,renameVar:Blockly.Language.procedures_callnoreturn.renameVar,customContextMenu:Blockly.Language.procedures_callnoreturn.customContextMenu};Blockly.Language.procedures_ifreturn={helpUrl:"http://c2.com/cgi/wiki?GuardClause",init:function(){this.setColour(290);this.appendValueInput("CONDITION").setCheck(Boolean).appendTitle(Blockly.LANG_CONTROLS_IF_MSG_IF);this.appendValueInput("VALUE").appendTitle(Blockly.LANG_PROCEDURES_DEFRETURN_RETURN);this.setInputsInline(true);this.setPreviousStatement(true);this.setNextStatement(true);this.setTooltip(Blockly.LANG_PROCEDURES_IFRETURN_TOOLTIP);this.hasReturnValue_=true},mutationToDom:function(){var a=document.createElement("mutation");a.setAttribute("value",Number(this.hasReturnValue_));return a},domToMutation:function(a){var b=a.getAttribute("value");this.hasReturnValue_=(b==1);if(!this.hasReturnValue_){this.removeInput("VALUE");this.appendDummyInput("VALUE").appendTitle(Blockly.LANG_PROCEDURES_DEFRETURN_RETURN)}},onchange:function(){if(!this.workspace){return}var a=false;var b=this;do{if(b.type=="procedures_defnoreturn"||b.type=="procedures_defreturn"){a=true;break}b=b.getSurroundParent()}while(b);if(a){if(b.type=="procedures_defnoreturn"&&this.hasReturnValue_){this.removeInput("VALUE");this.appendDummyInput("VALUE").appendTitle(Blockly.LANG_PROCEDURES_DEFRETURN_RETURN);this.hasReturnValue_=false}else{if(b.type=="procedures_defreturn"&&!this.hasReturnValue_){this.removeInput("VALUE");this.appendValueInput("VALUE").appendTitle(Blockly.LANG_PROCEDURES_DEFRETURN_RETURN);this.hasReturnValue_=true}}this.setWarningText(null)}else{this.setWarningText(Blockly.LANG_PROCEDURES_IFRETURN_WARNING)}}};